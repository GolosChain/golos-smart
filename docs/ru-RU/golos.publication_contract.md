# Смарт-контракт Golos.publication
## Назначение смарт-контракта Golos.publication
Смарт-контракт `golos.publication` обеспечивает работу с постами, в том числе предоставляет возможность пользователям выполнять следующие действия: публиковать посты, оставлять комментарии, голосовать за посты и закрывать посты, а также обеспечивает выплату вознаграждения авторам постов.  

## Операции-действия смарт-контракта golos.publication 
Cмарт-контракт `golos.publication` поддерживает следующие операции-действия пользователей: `setlimit`, `setrules`, `createmssg`, `updatemssg`, `deletemssg` и  `downvote`, `upvote`.

## Операция-действие setlimit 

Операция-действие `setlimit` устанавливает правила, ограничивающие действия пользователей. Механизм ограничения действий пользователей основан на взаимодействии смарт-контрактов публикации и батарейки (golos.charge). Создается привязка конкретного действия смарт-контракта публикации к конкретной батарейке смарт-контракта батарейки. В операции-действия указывается название действия (например, голосование или публикация поста), указывается идентификатор и параметры определенной батарейки.  

Операция-действие `setlimit` имеет следующий вид:  
```cpp
setlimit(
    std::string act,
    symbol_code token_code,
    uint8_t 	charge_id,
    int64_t 	price,
    int64_t 	cutoff,
    int64_t 	vesting_price,
    int64_t 	min_vesting
);
```

Параметры:  
`act` —  название действия;  
`token_code` —  код токена (тип данных, однозначно определяющий токен);  
`charge_id` —  идентификатор батарейки, ресурсами которой ограничивается действие `act`. К одной батарейке может быть создана привязка нескольких действий. Для действий голосования (`upvote`, `downvote`, `unvote`) значение идентификатора батарейки устанавливается нулевым;  
`price` —  цена (в условных единицах) расходуемого ресурса батарейки с идентификатором `charge_id` за совершаемое действие `act`. Значение ресурса батарейки уменьшается при каждом совершаемом действии и восстанавливается со временем;   
`cutoff` —  пороговое значение, ограничивающее снизу ресурс батарейки, при достижении которого действие `act` блокируется;  
`vesting_price` —  значении вестинга, которое необходимо выплатить пользователю за выполнение действия `act`, в случае исчерпания ресурса батарейки (достижение порогового значения снизу). Действие `act` будет выполнено, если пользователь разрешит снять с его баланса указанную сумму вестинга. Для оплаты необходимо, чтобы на балансе пользователя имелась необходимая сумма вестинга в разблокированном состоянии;  
`min_vesting` —  минимальное значение вестинга, которое необходимо иметь пользователю  на его балансе для выполнения действия `act`.  

Взаимодействие смарт-контрактов публикации и батарейки позволяет гибко настраивать ограничения на действия пользователей (например, действия по голосованию за посты, по публикации постов и оставлению комментариев можно соотнести с ресурсами трех разных батареек и тем самым ограничить активность пользователя по каждому из этих действий. Также все эти действия могут иметь привязку к одной и той же батарейки, то есть быть ограниченными ресурсами одной батарейки). За каждое выполняемое пользователем действие ему начисляется значение, соответствующее стоимости расходуемого ресурса батарейки. При достижении в смарт-контракте батарейки порогового значения используемого ресурса батарейки, действия пользователя блокируются до появления в ней необходимого ресурса.  

## Операция-действие setrules
Операция-действие `setrules` устанавливает правила в рамках приложения (сообщества) по распределению вознаграждения между пользователями за публикации постов и курирование.  
Операция-действие `setrules` имеет следующий вид:  
```cpp
void setrules(
    const funcparams&	mainfunc,
    const funcparams& 	curationfunc,
    const funcparams&	timepenalty,
    uint16_t 		    maxtokenprop,
    symbol 		        tokensymbol
);
```

Параметры:  
`mainfunc` —  функция, вычисляющая суммарное значение вознаграждения для автора и кураторов поста в соответствии с установленным алгоритмом (например, линейным алгоритмом или алгоритмом квадратного корня). Используемый в функции алгоритм выбирается делегатами голосованием. Функция содержит два параметра: математическое выражение (непосредственно алгоритм), по которому вычисляется сумма вознаграждения, и максимально допустимое значение аргумента для функции. При установке значений параметров для setrules выполняется их проверка на корректность (в том числе на монотонность и неотрицательность);  
`curationfunc` —  функция, вычисляющая значение вознаграждения для каждого из кураторов в соответствии с установленным алгоритмом (аналогично вычислению для `mainfunc`);  
`timepenalty` —  функция, вычисляющая вес голоса с учетом времени голосования и длительности штрафного окна;  
`maxtokenprop` —  максимально возможное значение вознаграждения (сумма токенов и вестингов), которое может получить автор. Этот параметр устанавливается делегатами голосованием. Целое число в сотых долях процента (от 0 до 10000 = 0%—100%);  
`tokensymbol` —  тип токена (в рамках приложения Голос предусматривается хождение только токенов Голоса).  

Правом на запуск операции-действия `setrules` обладает делегат приложения. Для запуска операции-действия `setrules` требуется наличие в транзакции подписи смарт-контракта `golos.publication` (multisig-аккаунта).  

## Операция-действие createmssg
Операция-действие `createmssg` используется для создания сообщения в виде ответа на ранее полученное (родительское) сообщение.  
Операция-действие `createmssg` имеет следующий вид:  
```cpp
void createmssg(
    name 		    account,
    std::string 	permlink,
    name 		    parentacc,
    std::string 	parentprmlnk,
    std::vector<structures::beneficiary> beneficiaries,
    uint16_t 	    tokenprop,
    bool 		    vestpayment,
    std::string 	headermssg,
    std::string 	bodymssg,
    std::string     languagemssg,
    std::vector<std::string> tags,
    std::string 	jsonmetadata,
    optional<uint16_t> curators_prcnt
);
```

Параметры:  
`account` — имя аккаунта-автора сообщения;  
`permlink` —  строковое представление относительного адреса сообщения;  
`parentacc` — имя аккаунта-автора родительского сообщения, на которое формируется ответ в виде настоящего сообщения. В случае нулевого значения `parentacc`, созданное сообщение будет являться постом;  
`parentprmlnk` — строковое представление относительного адреса родительского сообщения;  
`beneficiaries` — значение в виде структуры, содержащей имена бенефициаров и долю (в процентах) выплаты им от суммы вознаграждения за сообщение;  
`tokenprop` — размер вознаграждения (количество токенов). Данное значение ограничено сверху параметром `maxtokenprop`, задаваемым в `set_rules`;  
`vestpayment` — `true`, если пользователь дает разрешение на оплату в вестингах отправки сообщения в случае исчерпания ресурса батарейки (сообщение отправляется независимо от ресурса батарейки). По умолчанию принимает значение `false`;  
`headermssg` — заголовок сообщения;  
`bodymssg` — тело сообщения;  
`languagemssg` — язык сообщения;  
`tags` — тэг, который присваивается сообщению;  
`jsonmetadata` — метаданные в формате JSON;  
`curators_prcnt` — доля кураторского вознаграждения. Ограничивается диапазоном заданным в параметре `curators_prcnt_param`. Необязательный параметр, значение по умолчанию = `curators_prcnt_param.min_curators_prcnt`.

Параметры `parentacc`и `parentprmlnk` идентифицируют родительское сообщение, на которое создается ответ с использованием `createmssg` в виде сообщения.  

Для запуска операции-действия `createmssg` требуется наличие в транзакции подписи аккаунта-автора сообщения.  

Ключ, по которому ведется поиск сообщения, имеет привязку к параметрам `account` и `permlink`.  

## Операция-действие updatemssg
Операция-действие `updatemssg` используется для внесения пользователем изменений в ранее отправленное им сообщение.  

Операция-действие `updatemssg` имеет следующий вид:  
```cpp
void updatemssg(
    name 		account,
    std::string 	permlink,
    std::string 	headermssg,
    std::string 	bodymssg,
    std::string 	languagemssg,
    std::vector<std::string> tags,
    std::string 	jsonmetadata
);
```
Параметры:  
`account` — имя аккаунта-автора сообщения;  
`permlink` —  строковое представление относительного адреса редактируемого сообщения;  
`headermssg` — заголовок редактируемого сообщения;  
`bodymssg` — тело редактируемого сообщения;  
`languagemssg` — язык редактируемого сообщения;  
`tags` — тэг, который будет присвоен редактируемому сообщению;  
`jsonmetadata` — метаданные в формате JSON.  


Для запуска операции-действия `updatemssg` требуется наличие в транзакции подписи аккаунта-автора сообщения.  

## Операция-действие deletemssg
Операция-действие `deletemssg` используется для удаления пользователем ранее отправленного им сообщения.  

Операция-действие `deletemssg` имеет следующий вид:  
```cpp
void deletemssg(
    name account,
    std::string permlink
);
```
Параметры:  
`account` — имя аккаунта-автора сообщение;  
`permlink` —  строковое представление относительного адреса удаляемого сообщения.  

 
Сообщение не может быть удалено в следующих случаях:  
  * на сообщение создан комментарий;  
  * сообщение имеет положительное количество голосов. Вес голоса пользователя зависит от используемого им вестинга и силы голоса. Сообщение не может быть удалено, если взвешенная сумма имеет положительное значение.  

Для запуска операции-действия `deletemssg` требуется наличие в транзакции подписи аккаунта-автора сообщения.  

## Операция-действие upvote
Операция-действие `upvote` используется для подачи пользователем голоса в виде «upvote» при голосовании за сообщение.  
Операция-действие `upvote` имеет следующий вид:  
```cpp
void upvote(
    name voter,
    name author,
    std::string permlink,
    uint16_t weight
);
```
Параметры:  
`voter` — имя голосующего аккаунта;  
`author` — имя аккаунта-автора сообщения;  
`permlink` — строковое представление относительного адреса сообщения, за которое голосует аккаунт `voter`;  
`weight` — вес голоса аккаунта `voter`.  

Ключ, по которому ведется поиск сообщения, имеет привязку к значениям параметров `author` и `permlink`.  

Операция-действие `upvote` требует наличия подписи в транзакции аккаунта `voter`.  

## Операция-действие downvote
Операция-действие `downvote` используется для подачи пользователем голоса в виде «downvote» при голосовании за сообщение.  
Операция-действие `downvote` имеет следующий вид:  
```cpp
void downvote(
    name voter,
    name author,
    std::string permlink,
    uint16_t weight
);
```

Параметры:  
`voter` — имя голосующего аккаунта;  
`author` — имя аккаунта-автора сообщения;  
`permlink` — строковое представление относительного адреса сообщения, против которого голосует аккаунт `voter`;   
`weight` — вес голоса аккаунта `voter`.  

Ключ, по которому ведется поиск сообщения, имеет привязку к значениям параметров `author` и `permlink`.  

Операция-действие `downvote` требует наличия подписи в транзакции аккаунта `voter`.  

## Операция-действие unvote
Операция-действие `unvote` используется для отзыва пользователем собственного голоса вида `upvote` или `downvote`, отданного им ранее.  
Операция-действие `unvote` имеет следующий вид:  
```cpp
void unvote(
    name voter,
    name author,
    std::string permlink
);
```

Параметры:  
`voter` — имя аккаунта, удаляющего свой голос с сообщения;  
`author` — имя аккаунта-автора сообщения;  
`permlink` — строковое представление относительного адреса сообщения, от которого отзывается голос.  

Ключ, по которому ведется поиск сообщения, имеет привязку к значениям параметров `author` и `permlink`.  
 
Операция-действие `unvote` требует наличия подписи в транзакции аккаунта `voter`.

## Другие параметры, используемые и настраиваемые в смарт-контракте golos.publication
Вызов `set_params` в смарт-контракте `golos.publication` позволяет настроить следующие переменные:  
  * `cashout_window` — интервал времени, по истечении которого осуществляется выплата вознаграждения за пост;  
  * `max_vote_changes` — максимально возможное количество переголосований пользователя за пост (показывает, сколько раз пользователь может поменять свой голос за пост);  
  * `max_beneficiaries` — максимально возможное количество бенефициаров;
  * `max_comment_depth` — максимально возможная глубина комментариев (показывает допустимый уровень вложенности дочерних комментариев относительно родительского;  
  * `social_acc` — имя аккаунта social;  
  * `referral_acc` — имя аккаунта referral.  
 
## Расчёт стоимости постов
Для расчёта стоимости поста `payout` небоходимо получить  из Event Engine `rewardweight`, который приходит в виде целого числа в сотых долях процента. Так же при голосовании за пост в Event Engine будет приходить сообщение `poststate`, которое содержит текущие параметры стейта поста. Необходимо получить из Event Engine получить сообщение `poolstate` (pool выбирается по времени создания поста). После получения всех данных необходимо подставить в **формулу 1**.
##### Формула 1
###### payout = rewardweight::reward_weight * poolstate::state.funds * (poststate::sharesfn / poolstate::state::rsharesfn)
Процент кураторских может задоваться пользователем при создании поста в Event Engine будет отправлено сообщение `poststate`, если процент не указан, то берется нижняя граница из указанного интервала в параметрах в таблице `pstngparams`. Для получения суммы кураторских вознвграждений по **формуле 2**. 
##### Формула 2
###### payout -= poststate::sumcuratorsw * payout
Для расчёта кураторских выплат необходимо получить все сообщения сообщения Event Engine `votestate` в которых содержатся информация о куратарах. Из сообщения Event Engine `poststate` необходимо взять общий вес поста. После получения необходимой информации, необходимо пройти по списку кураторов и для каждого расчитать выплаты по **формуле 3**.
##### Формула 3
###### unclaimed_rewards = curation_payout
###### unclaimed_rewards -= curation_payout *  (votestate::curatorsw  / poststate::weights_sum)
После выплат кураторам оставшеяся сумма в unclaimed_rewards распределяется по пуллам.
Затем идёт расчёт выплат бенефециарам указанным при создании поста. Необходимо пройти по списку и совершить выплаты бенефициарам и получить общую сумму выплат `ben_payout_sum` по **формуле 4**. После расчёта `ben_payout_sum` необходимо получить сумму выплат автору поста по **формуле 5**.
##### Формула 4
###### ben_payout_sum += payout * post::beneficiary::deductprcnt
##### Формула 5
###### payout = payout - ben_payout_sum
После расчёта стоимости поста, необходимо получить пропорцию вознаграждения указанную при создании поста `tokenprop` по **формуле 6**.
##### Формула 6
###### token_payout = payout * post::tokenprop (выплата в токенах)
###### payout = payout - token_payout  (выплата в вестинге)

### Структуры Event Engine сообщений
#### Сообщение `poststate`:
```cpp
struct post_event {
    name author;
    std::string permlink;
    base_t netshares = 0;
    base_t voteshares = 0;
    base_t sumcuratorsw = 0;
    base_t sharesfn;
};
```
Параметры:
`author` - автор поста;
`permlink` - пермлин поста;
`netshares` - 
`voteshares` - 
`sumcuratorsw` - процент кураторских вознагрождений.
`sharesfn` - доля награды поста.
#### Сообщение `votestate`:
```cpp
struct vote_event {
    name voter;
    name author;
    std::string permlink;
    int16_t weight;
    base_t curatorsw;
    base_t rshares;
};
```
Параметры:
`voter` - пользователь который голосует за пост;
`author` - автор поста;
`permlink` - пермлинк поста;
`weight` - вес голоса за пост;
`curatorsw` - процент кураторского вознагрождения;
`rshares` - доля награды поста.
#### Сообщение `poolstate`:
```cpp
struct pool_event {
    uint64_t created;
    counter_t msgs;
    eosio::asset funds;
    wide_t rshares;
    wide_t rsharesfn;
};
```
Параметры:
`created` - создатель пулла;
`msgs` - колличество постов в пулле вознагрождений;
`funds` - колличество токенов в пулле вознагрождений;
`rshares` - доля награды поста;
`rsharesfn` - награды пулла.
#### Сообщение `rewardweight`:
```cpp
struct reward_weight_event {
    mssgid message_id;
    uint16_t rewardweight;
};
```
Параметры:
`message_id` - ключ-структура поста
`rewardweight` - вес награды за пост
